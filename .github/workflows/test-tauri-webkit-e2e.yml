name: Tauri Linux Distro Package Tests

on:
  pull_request:
    paths:
      - 'packages/tauri-service/**'
      - 'fixtures/package-tests/tauri-app-linux-distros/**'
      - 'fixtures/package-tests/tauri-app/**'
      - '.github/workflows/test-tauri-webkit-e2e.yml'
  workflow_dispatch:

jobs:
  linux-distro-tests:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          # Ubuntu scenarios
          - distro: ubuntu
            version: "24.04"
            scenario: base
            dockerfile: ubuntu-base.dockerfile
          - distro: ubuntu
            version: "24.04"
            scenario: with-webkit
            dockerfile: ubuntu-with-webkit.dockerfile

          # Fedora scenarios
          - distro: fedora
            version: "40"
            scenario: base
            dockerfile: fedora-base.dockerfile
          - distro: fedora
            version: "40"
            scenario: with-webkit
            dockerfile: fedora-with-webkit.dockerfile

          # Debian scenarios
          - distro: debian
            version: "12"
            scenario: base
            dockerfile: debian-base.dockerfile
          - distro: debian
            version: "12"
            scenario: with-webkit
            dockerfile: debian-with-webkit.dockerfile

          # CentOS Stream scenarios
          - distro: centos-stream
            version: "9"
            scenario: base
            dockerfile: centos-stream-base.dockerfile
          - distro: centos-stream
            version: "9"
            scenario: with-webkit
            dockerfile: centos-stream-with-webkit.dockerfile

          # Arch scenarios
          - distro: arch
            version: "latest"
            scenario: base
            dockerfile: arch-base.dockerfile
          - distro: arch
            version: "latest"
            scenario: with-webkit
            dockerfile: arch-with-webkit.dockerfile

          # Alpine scenarios
          - distro: alpine
            version: "latest"
            scenario: base
            dockerfile: alpine-base.dockerfile
          - distro: alpine
            version: "latest"
            scenario: with-webkit
            dockerfile: alpine-with-webkit.dockerfile

          # SUSE scenarios
          # Note: SUSE does not provide WebKitWebDriver in any official package,
          # so we only test the base scenario (auto-install behavior)
          - distro: suse
            version: "tumbleweed"
            scenario: base
            dockerfile: suse-base.dockerfile

          # Void scenarios
          - distro: void
            version: "latest"
            scenario: base
            dockerfile: void-base.dockerfile
          - distro: void
            version: "latest"
            scenario: with-webkit
            dockerfile: void-with-webkit.dockerfile

    name: ${{ matrix.distro }}-${{ matrix.version }} (${{ matrix.scenario }})

    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build test container
        run: |
          docker build \
            --build-arg BUILDKIT_INLINE_CACHE=1 \
            -f fixtures/package-tests/tauri-app-linux-distros/docker/${{ matrix.dockerfile }} \
            -t tauri-distro-test:${{ matrix.distro }}-${{ matrix.scenario }} \
            .

      - name: Run tests in container
        run: |
          docker run --rm \
            -u root \
            -v ${{ github.workspace }}:/workspace \
            -w /workspace \
            tauri-distro-test:${{ matrix.distro }}-${{ matrix.scenario }} \
            bash -c "
              set -e
              export TURBO_TELEMETRY_DISABLED=1

              echo '=== Installing dependencies ==='
              pnpm install --frozen-lockfile

              echo '=== Building tauri-service package ==='
              pnpm turbo run build --filter=@wdio/tauri-service

              echo '=== Building Tauri app ==='
              cd fixtures/package-tests/tauri-app
              pnpm run build:debug

              echo '=== Running Tauri package test ==='
              pnpm test
            "

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results-${{ matrix.distro }}-${{ matrix.scenario }}
          path: fixtures/package-tests/tauri-app/wdio-*.log
          if-no-files-found: ignore
