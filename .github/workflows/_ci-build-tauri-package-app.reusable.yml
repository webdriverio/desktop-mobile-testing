name: Build Tauri Package Test App
description: 'Builds Tauri package test application and creates shareable artifacts'

on:
  workflow_call:
    inputs:
      os:
        description: 'OS of runner'
        required: true
        type: string
      build-command:
        description: 'Build command for Tauri app (build or build:debug)'
        type: string
        default: 'build'
    outputs:
      build_id:
        description: 'Unique identifier for this build'
        value: ${{ jobs.build-tauri-package-app.outputs.build_id }}
      build_date:
        description: 'Timestamp when the build completed'
        value: ${{ jobs.build-tauri-package-app.outputs.build_date }}
      artifact_size:
        description: 'Size of the build artifact in bytes'
        value: ${{ jobs.build-tauri-package-app.outputs.artifact_size }}
      cache_key:
        description: 'Cache key used for artifact uploads, can be passed to download actions'
        value: ${{ jobs.build-tauri-package-app.outputs.cache_key }}

env:
  TURBO_TELEMETRY_DISABLED: 1
  TURBO_DAEMON: false

jobs:
  build-tauri-package-app:
    name: Build Tauri Package Test App
    runs-on: ${{ inputs.os }}
    outputs:
      build_id: ${{ steps.build-info.outputs.build_id }}
      build_date: ${{ steps.build-info.outputs.build_date }}
      artifact_size: ${{ steps.upload-archive.outputs.size || '0' }}
      cache_key: ${{ steps.upload-archive.outputs.cache_key }}
    steps:
      - name: üë∑ Checkout Repository
        uses: actions/checkout@v5
        with:
          ssh-key: ${{ secrets.DEPLOY_KEY }}

      - name: üõ†Ô∏è Setup Development Environment
        uses: ./.github/workflows/actions/setup-workspace
        with:
          node-version: '20'

      - name: ü¶Ä Install Rust Toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: ü¶Ä Install Tauri Dependencies (Linux)
        if: runner.os == 'Linux'
        shell: bash
        run: |
          echo "Installing Tauri dependencies for Linux..."
          sudo tee -a /etc/apt/sources.list > /dev/null <<EOT
          deb http://archive.ubuntu.com/ubuntu jammy main universe
          EOT
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            pkg-config \
            libgtk-3-dev \
            libwebkit2gtk-4.0-dev \
            libwebkit2gtk-4.1-dev \
            libappindicator3-dev \
            librsvg2-dev \
            patchelf \
            libglib2.0-dev \
            libsoup2.4-dev \
            libjavascriptcoregtk-4.0-dev \
            libjavascriptcoregtk-4.1-dev \
            libssl-dev \
            libasound2-dev \
            libx11-dev \
            libxext-dev \
            libxfixes-dev \
            libxrender-dev \
            libxrandr-dev \
            libxss-dev \
            libxtst-dev \
            libxcomposite-dev \
            libxcursor-dev \
            libxdamage-dev \
            libxinerama-dev \
            libxcb1-dev \
            libxcb-shape0-dev \
            libxcb-xfixes0-dev \
            libxcb-render0-dev \
            libxcb-randr0-dev \
            libxcb-xinerama0-dev \
            libxcb-xkb-dev \
            libxcb-image0-dev \
            libxcb-util0-dev \
            libxcb-icccm4-dev \
            libxcb-ewmh-dev \
            libxcb-dri2-0-dev

      - name: üìä Generate Build Information
        id: build-info
        shell: bash
        run: |
          echo "build_id=$(date +%s)-${{ github.run_id }}-${{ runner.os }}" >> $GITHUB_OUTPUT
          echo "build_date=$(date -u +"%Y-%m-%dT%H:%M:%SZ")" >> $GITHUB_OUTPUT

      # Debug: Check environment before build
      - name: üîç Debug Tauri Package App Build Environment
        shell: bash
        run: |
          echo "üîç Debugging Tauri package test app build environment..."
          APP_DIR="fixtures/package-tests/tauri-app/src-tauri"

          echo ""
          echo "=== Checking app directory structure ==="
          if [ -d "$APP_DIR" ]; then
            echo "‚úÖ App directory exists: $APP_DIR"
            ls -la "$APP_DIR" || echo "Failed to list app directory"
          else
            echo "‚ùå App directory NOT found: $APP_DIR"
          fi

          echo ""
          echo "=== Checking capabilities file ==="
          if [ -f "$APP_DIR/capabilities/default.json" ]; then
            echo "‚úÖ Capabilities file exists"
            echo "Capabilities file contents:"
            cat "$APP_DIR/capabilities/default.json" || echo "Failed to read capabilities file"

            # Check if identifier is "default"
            if grep -q '"identifier": "default"' "$APP_DIR/capabilities/default.json"; then
              echo "‚úÖ Capability identifier is 'default'"
            else
              echo "‚ùå Capability identifier is NOT 'default'"
              echo "Actual identifier:"
              grep '"identifier"' "$APP_DIR/capabilities/default.json" || echo "No identifier found"
            fi

            # Check for plugin permissions
            if grep -q "wdio:" "$APP_DIR/capabilities/default.json"; then
              echo "‚úÖ Plugin permissions found in capabilities file"
              echo "Plugin permissions:"
              grep "wdio:" "$APP_DIR/capabilities/default.json" || echo "Failed to grep"
            else
              echo "‚ö†Ô∏è  No plugin permissions found in capabilities file"
            fi
          else
            echo "‚ùå Capabilities file NOT found at $APP_DIR/capabilities/default.json"
            echo "Checking if capabilities directory exists:"
            ls -la "$APP_DIR/capabilities/" 2>/dev/null || echo "Capabilities directory does not exist"
          fi

          echo ""
          echo "=== Checking build.rs ==="
          if [ -f "$APP_DIR/build.rs" ]; then
            echo "‚úÖ build.rs exists"
            echo "build.rs contents:"
            cat "$APP_DIR/build.rs" || echo "Failed to read build.rs"
          else
            echo "‚ùå build.rs NOT found"
          fi

          echo ""
          echo "=== Checking plugin availability ==="
          if [ -d "packages/tauri-plugin" ]; then
            echo "‚úÖ Plugin directory exists"

            if [ -d "packages/tauri-plugin/permissions" ]; then
              echo "‚úÖ Plugin permissions directory exists"
              echo "Plugin permissions files:"
              ls -la "packages/tauri-plugin/permissions/" || echo "Failed to list permissions"

              if [ -f "packages/tauri-plugin/permissions/default.toml" ]; then
                echo "‚úÖ Plugin default.toml exists"
                echo "Plugin permissions file contents:"
                cat "packages/tauri-plugin/permissions/default.toml" || echo "Failed to read"
              else
                echo "‚ùå Plugin default.toml NOT found"
              fi
            else
              echo "‚ùå Plugin permissions directory NOT found"
            fi

            if [ -f "packages/tauri-plugin/build.rs" ]; then
              echo "‚úÖ Plugin build.rs exists"
            else
              echo "‚ùå Plugin build.rs NOT found"
            fi
          else
            echo "‚ùå Plugin directory NOT found"
          fi

          echo ""
          echo "=== Checking Cargo.toml ==="
          if [ -f "$APP_DIR/Cargo.toml" ]; then
            echo "‚úÖ Cargo.toml exists"
            if grep -q "tauri-plugin-wdio" "$APP_DIR/Cargo.toml"; then
              echo "‚úÖ Plugin dependency found in Cargo.toml"
              echo "Plugin dependency:"
              grep -A2 "tauri-plugin-wdio" "$APP_DIR/Cargo.toml" || echo "Failed to grep"
            else
              echo "‚ùå Plugin dependency NOT found in Cargo.toml"
            fi
          else
            echo "‚ùå Cargo.toml NOT found"
          fi

          echo ""
          echo "=== Checking for existing gen directory ==="
          if [ -d "$APP_DIR/gen" ]; then
            echo "‚ö†Ô∏è  gen directory already exists (should be cleaned before build)"
            echo "Contents:"
            find "$APP_DIR/gen" -type f | head -10 || echo "gen directory is empty"

            echo ""
            echo "Checking existing ACL manifest (if present):"
            if [ -f "$APP_DIR/gen/schemas/acl-manifests.json" ]; then
              echo "Existing ACL manifest found:"
              cat "$APP_DIR/gen/schemas/acl-manifests.json" | jq 'keys' 2>/dev/null || cat "$APP_DIR/gen/schemas/acl-manifests.json" | head -20

              if grep -q '"default"' "$APP_DIR/gen/schemas/acl-manifests.json" 2>/dev/null; then
                echo "‚úÖ Existing manifest has 'default' capability"
              else
                echo "‚ùå Existing manifest does NOT have 'default' capability"
              fi

              if grep -q '"wdio"' "$APP_DIR/gen/schemas/acl-manifests.json" 2>/dev/null; then
                echo "‚úÖ Existing manifest has 'wdio' plugin"
              else
                echo "‚ö†Ô∏è  Existing manifest does NOT have 'wdio' plugin"
              fi
            fi
          else
            echo "‚úÖ gen directory does not exist (will be created during build)"
          fi

      # CRITICAL: Clean gen directory before build to ensure fresh ACL manifest generation
      # The gen directory contains generated ACL manifests that must be regenerated with current plugin permissions
      - name: üßπ Clean Gen Directory
        shell: bash
        run: |
          APP_DIR="fixtures/package-tests/tauri-app/src-tauri"
          if [ -d "$APP_DIR/gen" ]; then
            echo "Cleaning gen directory to ensure fresh ACL manifest generation..."
            rm -rf "$APP_DIR/gen"
            echo "‚úÖ gen directory cleaned"
          else
            echo "gen directory does not exist, nothing to clean"
          fi

      - name: üèóÔ∏è Build Tauri Package Test App
        run: pnpm exec turbo run ${{ inputs.build-command }} --filter=tauri-app-example --only
        shell: bash

      # Debug: Check if ACL manifest was generated after build
      - name: üîç Debug ACL Manifest Generation (After Build)
        if: failure()
        shell: bash
        run: |
          echo "üîç Checking build output after failure..."
          APP_DIR="fixtures/package-tests/tauri-app/src-tauri"
          GEN_DIR="$APP_DIR/gen"
          ACL_MANIFEST="$GEN_DIR/schemas/acl-manifests.json"

          echo ""
          echo "=== Checking if gen directory was created ==="
          if [ -d "$GEN_DIR" ]; then
            echo "‚úÖ gen directory exists"
            echo "Contents:"
            find "$GEN_DIR" -type f | head -20 || echo "gen directory is empty"

            if [ -f "$ACL_MANIFEST" ]; then
              echo "‚úÖ ACL manifest exists"
              echo "ACL manifest keys:"
              cat "$ACL_MANIFEST" | jq 'keys' 2>/dev/null || cat "$ACL_MANIFEST" | head -50

              if grep -q '"default"' "$ACL_MANIFEST" 2>/dev/null; then
                echo "‚úÖ 'default' capability found in ACL manifest"
              else
                echo "‚ùå 'default' capability NOT found in ACL manifest"
              fi

              if grep -q '"wdio"' "$ACL_MANIFEST" 2>/dev/null; then
                echo "‚úÖ 'wdio' plugin found in ACL manifest"
              else
                echo "‚ö†Ô∏è  'wdio' plugin NOT found in ACL manifest"
              fi
            else
              echo "‚ùå ACL manifest NOT found at $ACL_MANIFEST"
            fi
          else
            echo "‚ùå gen directory NOT created - ACL manifest generation failed"
          fi

          echo ""
          echo "=== Checking plugin build output ==="
          if [ -d "packages/tauri-plugin/target" ]; then
            echo "Plugin target directory exists"
            echo "Looking for permissions in plugin target:"
            find "packages/tauri-plugin/target" -type d -name "permissions" | head -5 || echo "No permissions directories found"

            echo ""
            echo "Looking for OUT_DIR permissions:"
            find "packages/tauri-plugin/target" -path "*/permissions/wdio/*" -type f | head -5 || echo "No plugin permissions files found in OUT_DIR"
          fi

          echo ""
          echo "=== Checking app build output for plugin permissions ==="
          if [ -d "$APP_DIR/target" ]; then
            echo "App target directory exists"
            echo "Looking for plugin permissions in app target:"
            find "$APP_DIR/target" -type d -name "permissions" | head -5 || echo "No permissions directories found"

            echo ""
            echo "Looking for plugin OUT_DIR in app target:"
            find "$APP_DIR/target" -path "*/build/tauri-plugin-*/out/permissions/wdio/*" -type f | head -5 || echo "No plugin permissions found in app target"
          fi

      - name: üì¶ Upload Tauri Package Test App Binary
        id: upload-archive
        uses: ./.github/workflows/actions/upload-archive
        with:
          name: tauri-package-app-${{ runner.os }}
          output: tauri-package-app-${{ runner.os }}/artifact.zip
          paths: fixtures/package-tests/tauri-app/src-tauri/target
          cache_key_prefix: tauri-package-app
          retention_days: '90'

