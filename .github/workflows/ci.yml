name: CI

on:
  push:
    branches:
      - main
    tags:
      - v[0-9]+.[0-9]+.[0-9]+*
  pull_request:
  workflow_dispatch:

concurrency:
  group: ci-${{ github.workflow }}-${{ github.ref }}

env:
  TURBO_TELEMETRY_DISABLED: 1

jobs:
  # Build on Linux first since it's the fastest and its artifacts are used by all other jobs
  build:
    name: Build [Linux]
    uses: ./.github/workflows/_ci-build.reusable.yml
    with:
      os: 'ubuntu-latest'

  # Run linting after build to use the build artifacts
  lint:
    name: Lint [Linux]
    needs: [build]
    uses: ./.github/workflows/_ci-lint.reusable.yml
    with:
      cache_key: ${{ needs.build.outputs.cache_key }}

  # Run unit tests after linting to ensure code quality first
  unit-matrix:
    name: Unit [${{ matrix.os == 'ubuntu-latest' && 'Linux' || matrix.os == 'windows-latest' && 'Windows' || 'macOS' }}]
    needs: [build, lint]
    strategy:
      fail-fast: false
      matrix:
        # Test on all major operating systems to ensure cross-platform compatibility
        os: ['ubuntu-latest', 'windows-latest', 'macos-latest']
    uses: ./.github/workflows/_ci-unit.reusable.yml
    with:
      os: ${{ matrix.os }}
      build_id: ${{ needs.build.outputs.build_id }}
      artifact_size: ${{ needs.build.outputs.artifact_size }}
      cache_key: ${{ needs.build.outputs.cache_key }}

  # Build app binaries in parallel for better CI efficiency
  # Package test apps and E2E apps are built separately so tests don't wait for each other
  build-tauri-e2e-app-linux:
    name: Build Tauri E2E App [Linux]
    needs: [build]
    uses: ./.github/workflows/_ci-build-tauri-e2e-app.reusable.yml
    with:
      os: 'ubuntu-latest'
      build_id: ${{ needs.build.outputs.build_id }}
      artifact_size: ${{ needs.build.outputs.artifact_size }}
      cache_key: ${{ needs.build.outputs.cache_key }}

  build-tauri-e2e-app-windows:
    name: Build Tauri E2E App [Windows]
    needs: [build]
    uses: ./.github/workflows/_ci-build-tauri-e2e-app.reusable.yml
    with:
      os: 'windows-latest'
      build_id: ${{ needs.build.outputs.build_id }}
      artifact_size: ${{ needs.build.outputs.artifact_size }}
      cache_key: ${{ needs.build.outputs.cache_key }}

  build-tauri-package-app-linux:
    name: Build Tauri Package Test App [Linux]
    needs: [build]
    uses: ./.github/workflows/_ci-build-tauri-package-app.reusable.yml
    with:
      os: 'ubuntu-latest'

  build-tauri-package-app-windows:
    name: Build Tauri Package Test App [Windows]
    needs: [build]
    uses: ./.github/workflows/_ci-build-tauri-package-app.reusable.yml
    with:
      os: 'windows-latest'

  # Run package tests after unit tests to ensure the package is built correctly
  # Split Electron and Tauri tests across separate jobs for better parallelization and clarity
  # Electron apps are built inline on the test runner (faster builds, Turbo caching handles it)
  # Tauri apps are built separately due to longer build times and system dependencies
  package-electron-linux:
    name: Package - Electron [Linux]
    needs: [build, lint]
    uses: ./.github/workflows/_ci-package.reusable.yml
    with:
      os: 'ubuntu-latest'
      service: 'electron'
      build_id: ${{ needs.build.outputs.build_id }}
      artifact_size: ${{ needs.build.outputs.artifact_size }}
      cache_key: ${{ needs.build.outputs.cache_key }}

  package-electron-windows:
    name: Package - Electron [Windows]
    needs: [build, lint]
    uses: ./.github/workflows/_ci-package.reusable.yml
    with:
      os: 'windows-latest'
      service: 'electron'
      build_id: ${{ needs.build.outputs.build_id }}
      artifact_size: ${{ needs.build.outputs.artifact_size }}
      cache_key: ${{ needs.build.outputs.cache_key }}

  package-electron-macos:
    name: Package - Electron [macOS]
    needs: [build, lint]
    uses: ./.github/workflows/_ci-package.reusable.yml
    with:
      os: 'macos-latest'
      service: 'electron'
      build_id: ${{ needs.build.outputs.build_id }}
      artifact_size: ${{ needs.build.outputs.artifact_size }}
      cache_key: ${{ needs.build.outputs.cache_key }}

  package-tauri-linux:
    name: Package - Tauri [Linux]
    needs: [build, lint, build-tauri-package-app-linux]
    uses: ./.github/workflows/_ci-package.reusable.yml
    with:
      os: 'ubuntu-latest'
      service: 'tauri'
      build_id: ${{ needs.build.outputs.build_id }}
      artifact_size: ${{ needs.build.outputs.artifact_size }}
      cache_key: ${{ needs.build.outputs.cache_key }}
      tauri_cache_key: ${{ needs.build-tauri-package-app-linux.outputs.cache_key }}

  package-tauri-windows:
    name: Package - Tauri [Windows]
    needs: [build, lint, build-tauri-package-app-windows]
    uses: ./.github/workflows/_ci-package.reusable.yml
    with:
      os: 'windows-latest'
      service: 'tauri'
      build_id: ${{ needs.build.outputs.build_id }}
      artifact_size: ${{ needs.build.outputs.artifact_size }}
      cache_key: ${{ needs.build.outputs.cache_key }}
      tauri_cache_key: ${{ needs.build-tauri-package-app-windows.outputs.cache_key }}

  # Run build tests outside of the main Linux build job.
  build-matrix:
    name: Build [${{ matrix.os == 'ubuntu-latest' && 'Linux' || matrix.os == 'windows-latest' && 'Windows' || 'macOS' }}]
    needs: [build, lint]
    strategy:
      fail-fast: false
      matrix:
        os: ['windows-latest', 'macos-latest']
    uses: ./.github/workflows/_ci-build.reusable.yml
    with:
      os: ${{ matrix.os }}

  # E2E test matrix strategy:
  # - Run tests across 3 operating systems (Linux, Windows, macOS)
  # - Test 3 scenarios (builder, forge, no-binary)
  # - E2E tests use ESM only (CJS/ESM testing is done in package tests)
  # - Optimize for GitHub Actions concurrency limits
  e2e-matrix:
    name: E2E - Electron [${{ matrix.os == 'ubuntu-latest' && 'Linux' || matrix.os == 'windows-latest' && 'Windows' || 'macOS' }}] - ${{ matrix.scenario }}
    needs: [build]
    strategy:
      fail-fast: false
      matrix:
        # Test across all major operating systems
        os: ['ubuntu-latest', 'windows-latest', 'macos-latest']
        # Test all application scenarios
        scenario: ['builder', 'forge', 'no-binary']
    uses: ./.github/workflows/_ci-e2e.reusable.yml
    with:
      os: ${{ matrix.os }}
      node-version: '20'
      scenario: ${{ matrix.scenario }}
      build_id: ${{ needs.build.outputs.build_id }}
      artifact_size: ${{ needs.build.outputs.artifact_size }}
      cache_key: ${{ needs.build.outputs.cache_key }}

  # Tauri E2E tests for Linux - only waits for E2E app build
  # This allows Linux tests to start immediately after E2E app build completes
  e2e-tauri-linux-matrix:
    name: E2E - Tauri [Linux] - ${{ matrix.scenario }}${{ matrix.test-type != 'standard' && format(' ({0})', matrix.test-type) || '' }}
    needs: [build, build-tauri-e2e-app-linux]
    strategy:
      fail-fast: false
      matrix:
        scenario: ['tauri-basic']
        test-type: ['standard', 'multiremote', 'standalone']
    uses: ./.github/workflows/_ci-e2e-tauri.reusable.yml
    with:
      os: 'ubuntu-latest'
      node-version: '20'
      scenario: ${{ matrix.scenario }}
      test-type: ${{ matrix.test-type }}
      build_id: ${{ needs.build.outputs.build_id }}
      artifact_size: ${{ needs.build.outputs.artifact_size }}
      cache_key: ${{ needs.build.outputs.cache_key }}
      tauri_cache_key: ${{ needs.build-tauri-e2e-app-linux.outputs.cache_key }}

  # Tauri E2E tests for Windows - only waits for E2E app build
  # This allows Windows tests to start immediately after E2E app build completes
  e2e-tauri-windows-matrix:
    name: E2E - Tauri [Windows] - ${{ matrix.scenario }}${{ matrix.test-type != 'standard' && format(' ({0})', matrix.test-type) || '' }}
    needs: [build, build-tauri-e2e-app-windows]
    strategy:
      fail-fast: false
      matrix:
        scenario: ['tauri-basic']
        test-type: ['standard', 'multiremote', 'standalone']
    uses: ./.github/workflows/_ci-e2e-tauri.reusable.yml
    with:
      os: 'windows-latest'
      node-version: '20'
      scenario: ${{ matrix.scenario }}
      test-type: ${{ matrix.test-type }}
      build_id: ${{ needs.build.outputs.build_id }}
      artifact_size: ${{ needs.build.outputs.artifact_size }}
      cache_key: ${{ needs.build.outputs.cache_key }}
      tauri_cache_key: ${{ needs.build-tauri-e2e-app-windows.outputs.cache_key }}

  # Tauri E2E tests for macOS - skipped with clear messaging
  # macOS is not supported due to WKWebView WebDriver limitations
  e2e-tauri-macos-matrix:
    name: E2E - Tauri [macOS] - ${{ matrix.scenario }}${{ matrix.test-type != 'standard' && format(' ({0})', matrix.test-type) || '' }}
    needs: [build]
    strategy:
      fail-fast: false
      matrix:
        scenario: ['tauri-basic']
        test-type: ['standard', 'multiremote', 'standalone']
    uses: ./.github/workflows/_ci-e2e-tauri.reusable.yml
    with:
      os: 'macos-latest'
      node-version: '20'
      scenario: ${{ matrix.scenario }}
      test-type: ${{ matrix.test-type }}
      build_id: ${{ needs.build.outputs.build_id }}
      artifact_size: ${{ needs.build.outputs.artifact_size }}
      cache_key: ${{ needs.build.outputs.cache_key }}
      tauri_cache_key: ''

  # Mac Universal builds require special handling
  # These are separate from regular macOS tests because they use a different build command
  e2e-mac-universal-matrix:
    name: E2E [macOS-U] - ${{ matrix.scenario }}
    needs: [build]
    strategy:
      fail-fast: false
      matrix:
        # Test both application scenarios
        scenario: ['forge', 'builder']
    uses: ./.github/workflows/_ci-e2e.reusable.yml
    with:
      os: 'macos-latest'
      node-version: '20'
      build-command: 'build:mac-universal'
      scenario: ${{ matrix.scenario }}
      build_id: ${{ needs.build.outputs.build_id }}
      artifact_size: ${{ needs.build.outputs.artifact_size }}
      cache_key: ${{ needs.build.outputs.cache_key }}
