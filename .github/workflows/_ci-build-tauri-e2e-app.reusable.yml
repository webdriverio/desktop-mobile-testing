name: Build Tauri E2E App
description: 'Builds Tauri E2E test application and creates shareable artifacts'

on:
  workflow_call:
    inputs:
      os:
        description: 'OS of runner'
        required: true
        type: string
      build-command:
        description: 'Build command for Tauri app (build or build:debug)'
        type: string
        default: 'build'
      build_id:
        description: 'Build ID from the main build job'
        type: string
        required: false
      artifact_size:
        description: 'Size of the build artifact in bytes'
        type: string
        required: false
      cache_key:
        description: 'Cache key to use for downloading artifacts'
        type: string
        required: false
    outputs:
      build_id:
        description: 'Unique identifier for this build'
        value: ${{ jobs.build-tauri-e2e-app.outputs.build_id }}
      build_date:
        description: 'Timestamp when the build completed'
        value: ${{ jobs.build-tauri-e2e-app.outputs.build_date }}
      artifact_size:
        description: 'Size of the build artifact in bytes'
        value: ${{ jobs.build-tauri-e2e-app.outputs.artifact_size }}
      cache_key:
        description: 'Cache key used for artifact uploads, can be passed to download actions'
        value: ${{ jobs.build-tauri-e2e-app.outputs.cache_key }}

env:
  TURBO_TELEMETRY_DISABLED: 1
  TURBO_DAEMON: false

jobs:
  build-tauri-e2e-app:
    name: Build Tauri E2E App
    runs-on: ${{ inputs.os }}
    outputs:
      build_id: ${{ steps.build-info.outputs.build_id }}
      build_date: ${{ steps.build-info.outputs.build_date }}
      artifact_size: ${{ steps.upload-archive.outputs.size || '0' }}
      cache_key: ${{ steps.upload-archive.outputs.cache_key }}
    steps:
      - name: ğŸ‘· Checkout Repository
        uses: actions/checkout@v5
        with:
          ssh-key: ${{ secrets.DEPLOY_KEY }}

      - name: ğŸ› ï¸ Setup Development Environment
        uses: ./.github/workflows/actions/setup-workspace
        with:
          node-version: '20'

      - name: ğŸ¦€ Install Rust Toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: ğŸ¦€ Install Tauri Dependencies (Linux)
        if: runner.os == 'Linux'
        shell: bash
        run: |
          echo "Installing Tauri dependencies for Linux..."
          sudo tee -a /etc/apt/sources.list > /dev/null <<EOT
          deb http://archive.ubuntu.com/ubuntu jammy main universe
          EOT
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            pkg-config \
            libgtk-3-dev \
            libwebkit2gtk-4.0-dev \
            libwebkit2gtk-4.1-dev \
            libappindicator3-dev \
            librsvg2-dev \
            patchelf \
            libglib2.0-dev \
            libsoup2.4-dev \
            libjavascriptcoregtk-4.0-dev \
            libjavascriptcoregtk-4.1-dev \
            libssl-dev \
            libasound2-dev \
            libx11-dev \
            libxext-dev \
            libxfixes-dev \
            libxrender-dev \
            libxrandr-dev \
            libxss-dev \
            libxtst-dev \
            libxcomposite-dev \
            libxcursor-dev \
            libxdamage-dev \
            libxinerama-dev \
            libxcb1-dev \
            libxcb-shape0-dev \
            libxcb-xfixes0-dev \
            libxcb-render0-dev \
            libxcb-randr0-dev \
            libxcb-xinerama0-dev \
            libxcb-xkb-dev \
            libxcb-image0-dev \
            libxcb-util0-dev \
            libxcb-icccm4-dev \
            libxcb-ewmh-dev \
            libxcb-dri2-0-dev

      - name: ğŸ“Š Generate Build Information
        id: build-info
        shell: bash
        run: |
          echo "build_id=$(date +%s)-${{ github.run_id }}-${{ runner.os }}" >> $GITHUB_OUTPUT
          echo "build_date=$(date -u +"%Y-%m-%dT%H:%M:%SZ")" >> $GITHUB_OUTPUT

      # Download the pre-built packages from the main build job
      # This ensures we use the same build artifacts and avoid rebuilding Node.js packages
      - name: ğŸ“¦ Download Package Build Artifacts
        uses: ./.github/workflows/actions/download-archive
        with:
          name: wdio-electron-service
          path: wdio-electron-service-build
          filename: artifact.zip
          cache_key_prefix: wdio-electron-build
          exact_cache_key: ${{ inputs.cache_key || github.run_id && format('{0}-{1}-{2}-{3}{4}', 'Linux', 'wdio-electron-build', 'wdio-electron-service', github.run_id, github.run_attempt > 1 && format('-rerun{0}', github.run_attempt) || '') || '' }}

      # Display build information if available
      - name: ğŸ“Š Show Build Information
        if: inputs.build_id != '' && inputs.artifact_size != ''
        shell: bash
        run: |
          echo "::notice::Build artifact: ID=${{ inputs.build_id }}, Size=${{ inputs.artifact_size }} bytes"

      # Install dependencies to ensure workspace is properly set up
      # This is needed after downloading artifacts to ensure all workspace links are correct
      - name: ğŸ“¦ Install Dependencies
        run: pnpm install
        shell: bash

      # Build the Tauri plugin's JavaScript first
      # This is needed by the E2E app's build process (for bundling)
      - name: ğŸ—ï¸ Build Tauri Plugin JavaScript
        run: pnpm exec turbo run build:js --filter=@wdio/tauri-plugin
        shell: bash

      # Clean the E2E app's existing build artifacts to ensure a fresh build
      # This ensures the plugin's permissions are properly discovered and merged
      # Note: We don't need to explicitly build the plugin's Rust code here because
      # Cargo will automatically build it as a dependency when building the app
      # (the plugin is a path dependency in Cargo.toml)
      - name: ğŸ§¹ Clean E2E App Build Artifacts
        shell: bash
        run: |
          # Clean the E2E app's build artifacts (including gen directory)
          if [ -d "fixtures/e2e-apps/tauri/src-tauri/gen" ]; then
            rm -rf fixtures/e2e-apps/tauri/src-tauri/gen
          fi
          if [ -d "fixtures/e2e-apps/tauri/src-tauri/target" ]; then
            rm -rf fixtures/e2e-apps/tauri/src-tauri/target
          fi

      # Build Tauri E2E App
      # Cargo will automatically build the plugin (as a path dependency) before building the app
      # The plugin's build.rs will copy permissions to OUT_DIR, which the app's build.rs
      # will discover and merge into the ACL manifest
      # Node.js packages are already built from the downloaded artifacts
      - name: ğŸ—ï¸ Build Tauri E2E App
        run: pnpm exec turbo run ${{ inputs.build-command }} --filter=tauri-e2e-app
        shell: bash

      - name: ğŸ“¦ Upload Tauri E2E App Binary
        id: upload-archive
        uses: ./.github/workflows/actions/upload-archive
        with:
          name: tauri-e2e-app-${{ runner.os }}
          output: tauri-e2e-app-${{ runner.os }}/artifact.zip
          paths: fixtures/e2e-apps/tauri/src-tauri/target
          cache_key_prefix: tauri-e2e-app
          retention_days: '90'

