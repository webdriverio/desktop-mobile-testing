name: Build Tauri E2E App
description: 'Builds Tauri E2E test application and creates shareable artifacts'

on:
  workflow_call:
    inputs:
      os:
        description: 'OS of runner'
        required: true
        type: string
      build-command:
        description: 'Build command for Tauri app (build or build:debug)'
        type: string
        default: 'build'
      build_id:
        description: 'Build ID from the main build job'
        type: string
        required: false
      artifact_size:
        description: 'Size of the build artifact in bytes'
        type: string
        required: false
      cache_key:
        description: 'Cache key to use for downloading artifacts'
        type: string
        required: false
    outputs:
      build_id:
        description: 'Unique identifier for this build'
        value: ${{ jobs.build-tauri-e2e-app.outputs.build_id }}
      build_date:
        description: 'Timestamp when the build completed'
        value: ${{ jobs.build-tauri-e2e-app.outputs.build_date }}
      artifact_size:
        description: 'Size of the build artifact in bytes'
        value: ${{ jobs.build-tauri-e2e-app.outputs.artifact_size }}
      cache_key:
        description: 'Cache key used for artifact uploads, can be passed to download actions'
        value: ${{ jobs.build-tauri-e2e-app.outputs.cache_key }}

env:
  TURBO_TELEMETRY_DISABLED: 1
  TURBO_DAEMON: false

jobs:
  build-tauri-e2e-app:
    name: Build Tauri E2E App
    runs-on: ${{ inputs.os }}
    outputs:
      build_id: ${{ steps.build-info.outputs.build_id }}
      build_date: ${{ steps.build-info.outputs.build_date }}
      artifact_size: ${{ steps.upload-archive.outputs.size || '0' }}
      cache_key: ${{ steps.upload-archive.outputs.cache_key }}
    steps:
      - name: üë∑ Checkout Repository
        uses: actions/checkout@v5
        with:
          ssh-key: ${{ secrets.DEPLOY_KEY }}

      - name: üõ†Ô∏è Setup Development Environment
        uses: ./.github/workflows/actions/setup-workspace
        with:
          node-version: '20'

      - name: ü¶Ä Install Rust Toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: ü¶Ä Install Tauri Dependencies (Linux)
        if: runner.os == 'Linux'
        shell: bash
        run: |
          echo "Installing Tauri dependencies for Linux..."
          sudo tee -a /etc/apt/sources.list > /dev/null <<EOT
          deb http://archive.ubuntu.com/ubuntu jammy main universe
          EOT
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            pkg-config \
            libgtk-3-dev \
            libwebkit2gtk-4.0-dev \
            libwebkit2gtk-4.1-dev \
            libappindicator3-dev \
            librsvg2-dev \
            patchelf \
            libglib2.0-dev \
            libsoup2.4-dev \
            libjavascriptcoregtk-4.0-dev \
            libjavascriptcoregtk-4.1-dev \
            libssl-dev \
            libasound2-dev \
            libx11-dev \
            libxext-dev \
            libxfixes-dev \
            libxrender-dev \
            libxrandr-dev \
            libxss-dev \
            libxtst-dev \
            libxcomposite-dev \
            libxcursor-dev \
            libxdamage-dev \
            libxinerama-dev \
            libxcb1-dev \
            libxcb-shape0-dev \
            libxcb-xfixes0-dev \
            libxcb-render0-dev \
            libxcb-randr0-dev \
            libxcb-xinerama0-dev \
            libxcb-xkb-dev \
            libxcb-image0-dev \
            libxcb-util0-dev \
            libxcb-icccm4-dev \
            libxcb-ewmh-dev \
            libxcb-dri2-0-dev

      - name: üìä Generate Build Information
        id: build-info
        shell: bash
        run: |
          echo "build_id=$(date +%s)-${{ github.run_id }}-${{ runner.os }}" >> $GITHUB_OUTPUT
          echo "build_date=$(date -u +"%Y-%m-%dT%H:%M:%SZ")" >> $GITHUB_OUTPUT

      # Download the pre-built packages from the main build job
      # This ensures we use the same build artifacts and avoid rebuilding Node.js packages
      - name: üì¶ Download Package Build Artifacts
        uses: ./.github/workflows/actions/download-archive
        with:
          name: wdio-electron-service
          path: wdio-electron-service-build
          filename: artifact.zip
          cache_key_prefix: wdio-electron-build
          exact_cache_key: ${{ inputs.cache_key || github.run_id && format('{0}-{1}-{2}-{3}{4}', 'Linux', 'wdio-electron-build', 'wdio-electron-service', github.run_id, github.run_attempt > 1 && format('-rerun{0}', github.run_attempt) || '') || '' }}

      # Display build information if available
      - name: üìä Show Build Information
        if: inputs.build_id != '' && inputs.artifact_size != ''
        shell: bash
        run: |
          echo "::notice::Build artifact: ID=${{ inputs.build_id }}, Size=${{ inputs.artifact_size }} bytes"

      # Install dependencies to ensure workspace is properly set up
      # This is needed after downloading artifacts to ensure all workspace links are correct
      - name: üì¶ Install Dependencies
        run: pnpm install
        shell: bash

      # Build the Tauri plugin's JavaScript first
      # This is needed by the E2E app's build process (for bundling)
      - name: üèóÔ∏è Build Tauri Plugin JavaScript
        run: pnpm exec turbo run build:js --filter=@wdio/tauri-plugin
        shell: bash

      # Clean the E2E app's existing build artifacts to ensure a fresh build
      # This ensures the plugin's permissions are properly discovered and merged
      # Note: We don't need to explicitly build the plugin's Rust code here because
      # Cargo will automatically build it as a dependency when building the app
      # (the plugin is a path dependency in Cargo.toml)
      - name: üßπ Clean E2E App Build Artifacts
        shell: bash
        run: |
          # Clean the E2E app's build artifacts (including gen directory)
          if [ -d "fixtures/e2e-apps/tauri/src-tauri/gen" ]; then
            rm -rf fixtures/e2e-apps/tauri/src-tauri/gen
          fi
          if [ -d "fixtures/e2e-apps/tauri/src-tauri/target" ]; then
            rm -rf fixtures/e2e-apps/tauri/src-tauri/target
          fi

      # Debug: Check environment before build
      - name: üîç Debug Tauri App Build Environment
        shell: bash
        run: |
          echo "üîç Debugging Tauri E2E app build environment..."
          APP_DIR="fixtures/e2e-apps/tauri/src-tauri"

          echo "Checking app directory structure..."
          ls -la "$APP_DIR" || echo "Failed to list app directory"

          echo ""
          echo "Checking capabilities file..."
          if [ -f "$APP_DIR/capabilities/default.json" ]; then
            echo "‚úÖ Capabilities file exists"
            cat "$APP_DIR/capabilities/default.json" | head -20 || echo "Failed to read capabilities file"

            # Check if identifier is "default"
            if grep -q '"identifier": "default"' "$APP_DIR/capabilities/default.json"; then
              echo "‚úÖ Capability identifier is 'default'"
            else
              echo "‚ùå Capability identifier is NOT 'default'"
            fi
          else
            echo "‚ùå Capabilities file NOT found at $APP_DIR/capabilities/default.json"
          fi

          echo ""
          echo "Checking build.rs..."
          if [ -f "$APP_DIR/build.rs" ]; then
            echo "‚úÖ build.rs exists"
            cat "$APP_DIR/build.rs" || echo "Failed to read build.rs"
          else
            echo "‚ùå build.rs NOT found"
          fi

          echo ""
          echo "Checking plugin availability..."
          if [ -d "packages/tauri-plugin" ]; then
            echo "‚úÖ Plugin directory exists"
            if [ -d "packages/tauri-plugin/permissions" ]; then
              echo "‚úÖ Plugin permissions directory exists"
              ls -la "packages/tauri-plugin/permissions/" || echo "Failed to list permissions"
            else
              echo "‚ùå Plugin permissions directory NOT found"
            fi
          else
            echo "‚ùå Plugin directory NOT found"
          fi

          echo ""
          echo "Checking Cargo.toml for plugin dependency..."
          if [ -f "$APP_DIR/Cargo.toml" ]; then
            if grep -q "tauri-plugin-wdio" "$APP_DIR/Cargo.toml"; then
              echo "‚úÖ Plugin dependency found in Cargo.toml"
              grep -A2 "tauri-plugin-wdio" "$APP_DIR/Cargo.toml" || echo "Failed to grep Cargo.toml"
            else
              echo "‚ùå Plugin dependency NOT found in Cargo.toml"
            fi
          fi

      # Build Tauri E2E App
      # Cargo will automatically build the plugin (as a path dependency) before building the app
      # The plugin's build.rs will copy permissions to OUT_DIR, which the app's build.rs
      # will discover and merge into the ACL manifest
      # Node.js packages are already built from the downloaded artifacts
      - name: üèóÔ∏è Build Tauri E2E App
        run: pnpm exec turbo run ${{ inputs.build-command }} --filter=tauri-e2e-app
        shell: bash

      # Debug: Check if ACL manifest was generated after build
      - name: üîç Debug ACL Manifest Generation
        if: failure()
        shell: bash
        run: |
          echo "üîç Checking ACL manifest generation after build failure..."
          APP_DIR="fixtures/e2e-apps/tauri/src-tauri"
          GEN_DIR="$APP_DIR/gen"
          ACL_MANIFEST="$GEN_DIR/schemas/acl-manifests.json"

          echo ""
          echo "=== Checking gen directory ==="
          if [ -d "$GEN_DIR" ]; then
            echo "‚úÖ gen directory exists"
            echo "Contents:"
            find "$GEN_DIR" -type f | head -20 || echo "gen directory is empty"

            if [ -f "$ACL_MANIFEST" ]; then
              echo "‚úÖ ACL manifest exists"
              echo "ACL manifest keys:"
              cat "$ACL_MANIFEST" | jq 'keys' 2>/dev/null || cat "$ACL_MANIFEST" | head -50

              if grep -q '"default"' "$ACL_MANIFEST" 2>/dev/null; then
                echo "‚úÖ 'default' capability found in ACL manifest"
              else
                echo "‚ùå 'default' capability NOT found in ACL manifest"
                echo "This is the root cause of the error!"
                echo "Full manifest contents:"
                cat "$ACL_MANIFEST" || echo "Failed to read manifest"
              fi

              if grep -q '"wdio"' "$ACL_MANIFEST" 2>/dev/null; then
                echo "‚úÖ 'wdio' plugin found in ACL manifest"
              else
                echo "‚ö†Ô∏è  'wdio' plugin NOT found in ACL manifest"
              fi
            else
              echo "‚ùå ACL manifest NOT found at $ACL_MANIFEST"
              echo "This indicates ACL manifest generation failed before creating the manifest"
            fi
          else
            echo "‚ùå gen directory NOT created - ACL manifest generation failed completely"
            echo "This means tauri_build::try_build() failed before generating any output"
          fi

          echo ""
          echo "=== Checking plugin build output (plugin's OUT_DIR) ==="
          if [ -d "packages/tauri-plugin/target" ]; then
            echo "Plugin target directory exists"
            echo "Looking for permissions in plugin's OUT_DIR..."
            find "packages/tauri-plugin/target" -path "*/out/permissions/wdio/*" -type f | head -10 || echo "No plugin permissions found in plugin OUT_DIR"

            echo ""
            echo "All permission directories in plugin target:"
            find "packages/tauri-plugin/target" -type d -name "permissions" | head -10 || echo "No permissions directories found"
          else
            echo "‚ö†Ô∏è  Plugin target directory does not exist"
          fi

          echo ""
          echo "=== Checking app build output for plugin permissions (app's dependency OUT_DIR) ==="
          if [ -d "$APP_DIR/target" ]; then
            echo "App target directory exists"
            echo "Looking for plugin permissions in app's dependency build output..."
            echo "These should be at: target/release/build/tauri-plugin-wdio-*/out/permissions/wdio/"
            find "$APP_DIR/target" -path "*/build/tauri-plugin-wdio-*/out/permissions/wdio/*" -type f | head -10 || echo "‚ùå No plugin permissions found in app's dependency OUT_DIR"

            echo ""
            echo "All permission directories in app target:"
            find "$APP_DIR/target" -type d -name "permissions" | head -10 || echo "No permissions directories found"

            echo ""
            echo "Checking for plugin build output directories:"
            find "$APP_DIR/target" -type d -name "tauri-plugin-wdio-*" | head -5 || echo "No plugin build directories found"
          else
            echo "‚ùå App target directory does not exist (build failed very early)"
          fi

          echo ""
          echo "=== Checking if plugin's build.rs ran ==="
          echo "Looking for plugin build script output..."
          if [ -d "$APP_DIR/target" ]; then
            echo "Checking for cargo:rerun-if-changed messages in build output..."
            # The build output would show if build.rs ran
            echo "Note: Build script execution is logged in Cargo's build output"
          fi

      - name: üì¶ Upload Tauri E2E App Binary
        id: upload-archive
        uses: ./.github/workflows/actions/upload-archive
        with:
          name: tauri-e2e-app-${{ runner.os }}
          output: tauri-e2e-app-${{ runner.os }}/artifact.zip
          paths: fixtures/e2e-apps/tauri/src-tauri/target
          cache_key_prefix: tauri-e2e-app
          retention_days: '90'

