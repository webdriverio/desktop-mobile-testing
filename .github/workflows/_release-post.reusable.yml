name: Release Post (Reusable)

on:
  workflow_call:
    inputs:
      service:
        description: 'Service that was released (electron or tauri)'
        required: true
        type: string
      service_release_tag:
        description: 'The service release tag'
        required: true
        type: string
      shared_release_tags:
        description: 'Comma-separated shared package tags'
        required: false
        type: string
      is_prerelease:
        description: 'Whether this is a pre-release'
        required: true
        type: boolean
      dry_run:
        description: 'Dry run mode'
        required: false
        type: boolean
        default: false
    secrets:
      github_bot_token:
        description: 'GitHub token for authentication'
        required: true

jobs:
  create-releases:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Create service GitHub release
        if: ${{ !inputs.dry_run && inputs.service_release_tag != '' }}
        env:
          GH_TOKEN: ${{ secrets.github_bot_token }}
        run: |
          TAG="${{ inputs.service_release_tag }}"
          SERVICE="${{ inputs.service }}"
          
          echo "Creating GitHub release for $TAG"
          
          # Build release title
          if [ "${{ inputs.is_prerelease }}" = "true" ]; then
            TITLE="${SERVICE^} Service Pre-release ${TAG}"
          else
            TITLE="${SERVICE^} Service ${TAG}"
          fi
          
          # Create the release
          gh release create "$TAG" \
            --draft \
            --generate-notes \
            --title "$TITLE" \
            ${{ inputs.is_prerelease && '--prerelease' || '' }} \
            --notes "Release of the ${SERVICE} service and related packages.

          This release includes:
          - Service packages for ${SERVICE}
          ${{ inputs.shared_release_tags != '' && '- Updated shared packages' || '' }}
          
          See the full changelog below for details."
          
          echo "✅ Created release for $TAG"

      - name: Create shared package releases
        if: ${{ !inputs.dry_run && inputs.shared_release_tags != '' }}
        env:
          GH_TOKEN: ${{ secrets.github_bot_token }}
        run: |
          # Split comma-separated tags
          IFS=',' read -ra TAGS <<< "${{ inputs.shared_release_tags }}"
          
          for TAG in "${TAGS[@]}"; do
            if [ -n "$TAG" ]; then
              echo "Creating GitHub release for $TAG"
              
              # Extract package name from tag (e.g., native-utils-v1.2.3 -> native-utils)
              PACKAGE_NAME=$(echo "$TAG" | sed 's/-v[0-9].*//')
              
              gh release create "$TAG" \
                --draft \
                --generate-notes \
                --title "Shared Package: ${PACKAGE_NAME} ${TAG}" \
                --notes "Release of the @wdio/${PACKAGE_NAME} shared package.
          
          This package is used by both Electron and Tauri services.
          
          See the full changelog below for details."
              
              echo "✅ Created release for $TAG"
            fi
          done

      - name: Log dry run summary
        if: ${{ inputs.dry_run }}
        run: |
          echo "========== DRY RUN: GitHub Releases =========="
          echo "Would create the following releases:"
          echo ""
          
          if [ -n "${{ inputs.service_release_tag }}" ]; then
            echo "Service Release:"
            echo "  - Tag: ${{ inputs.service_release_tag }}"
            echo "  - Title: ${{ inputs.service }} Service ${{ inputs.service_release_tag }}"
            echo "  - Pre-release: ${{ inputs.is_prerelease }}"
            echo "  - Draft: true"
            echo ""
          fi
          
          if [ -n "${{ inputs.shared_release_tags }}" ]; then
            echo "Shared Package Releases:"
            IFS=',' read -ra TAGS <<< "${{ inputs.shared_release_tags }}"
            for TAG in "${TAGS[@]}"; do
              if [ -n "$TAG" ]; then
                PACKAGE_NAME=$(echo "$TAG" | sed 's/-v[0-9].*//')
                echo "  - Tag: $TAG (${PACKAGE_NAME})"
              fi
            done
          fi
          
          echo "=============================================="

      - name: Post-release summary
        run: |
          echo "========== RELEASE COMPLETE =========="
          echo "Service: ${{ inputs.service }}"
          echo "Service Tag: ${{ inputs.service_release_tag }}"
          if [ -n "${{ inputs.shared_release_tags }}" ]; then
            echo "Shared Tags: ${{ inputs.shared_release_tags }}"
          fi
          echo "Pre-release: ${{ inputs.is_prerelease }}"
          echo "Dry Run: ${{ inputs.dry_run }}"
          echo ""
          echo "Next steps:"
          echo "  1. Review and publish the draft releases on GitHub"
          echo "  2. Verify packages on NPM and crates.io"
          echo "  3. Update documentation if needed"
          echo "======================================"
